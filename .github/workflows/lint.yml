name: ⚙️ Lint

on:
  pull_request:
  push:
    branches:
      - main
      - '!release/**'

env:
  NX_BRANCH: ${{ github.event.number }}
  NX_CLOUD_AUTH_TOKEN: ${{ secrets.NX_CLOUD_AUTH_TOKEN }}
  RUN_AUTOFIX:
    ${{ github.event.pull_request.head.repo.full_name == github.repository && github.ref != 'refs/heads/main' &&
    (github.actor != 'dependabot[bot]' || github.actor != 'dependabot-preview[bot]') }}

jobs:
  typecheck:
    if: ${{ !contains(github.head_ref, 'release/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js and Cache
        uses: ./.github/actions/nodejs
      - name: Typecheck
        run: npm run typecheck

  prettier:
    if: ${{ !contains(github.head_ref, 'release/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js and Cache
        uses: ./.github/actions/nodejs
      - name: Run prettier
        run: npm run prettier ${{ env.RUN_AUTOFIX == 'true' && '-- --write' || '' }}

  stylelint:
    if: ${{ !contains(github.head_ref, 'release/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js and Cache
        uses: ./.github/actions/nodejs
      - name: Run Stylelint
        run: npm run stylelint ${{ env.RUN_AUTOFIX == 'true' && '-- --fix' || '' }}

  eslint:
    if: ${{ !contains(github.head_ref, 'release/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js and Cache
        uses: ./.github/actions/nodejs
      - name: Run Eslint
        run: npm run lint ${{ env.RUN_AUTOFIX == 'true' && '-- --fix' || '' }}

  auto-push-fixed-files:
    if: ${{ !contains(github.head_ref, 'release/') }}
    runs-on: ubuntu-latest
    needs: [typecheck, prettier, eslint, stylelint]
    steps:
      - uses: actions/checkout@v3
      - name: Apply changes after linting
        if: ${{ env.RUN_AUTOFIX == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_user_name: 'tinkoff-bot'
          commit_user_email: 'tinkoff-bot@users.noreply.github.com'
          commit_author: 'tinkoff-bot <tinkoff-bot@users.noreply.github.com>'
          commit_message: 'chore: apply changes after linting [tinkoff-bot]'
          status_options: '--untracked-files=no'
          commit_options: '--no-verify'
          skip_fetch: true

concurrency:
  group: lint-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
